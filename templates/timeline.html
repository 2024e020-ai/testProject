{% extends 'base.html' %}
{% block title %}ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³{% endblock %}

{% block content %}
<h2 class="mb-4">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h2>

<!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
<form class="d-flex mb-4" method="GET" action="{% url 'timeline' %}">
  <input class="form-control me-2" type="search" placeholder="æ¤œç´¢"
         name="q" value="{{ query }}">
  <button class="btn btn-outline-success" type="submit">æ¤œç´¢</button>
</form>

<!-- æ¤œç´¢çµæœè¡¨ç¤º -->
{% if query %}
  <h3>ã€Œ{{ query }}ã€ã®æ¤œç´¢çµæœ</h3>
{% endif %}

<!-- æŠ•ç¨¿ä¸€è¦§ -->
{% for post in posts %}
<div class="card mb-3 post" data-post-id="{{ post.id }}">
  <div class="card-body">
    <h5 class="card-title">{{ post.title }}</h5>
    <p class="card-text">{{ post.content|truncatechars:100 }}</p>
    <p class="card-text">
      <small class="text-muted">{{ post.author.username }} | {{ post.created_at }}</small>
    </p>
    <a href="{% url 'post_detail' post.pk %}" class="btn btn-primary btn-sm">è©³ç´°</a>

    <!-- ã„ã„ã­ãƒœã‚¿ãƒ³ -->
    <button class="btn btn-outline-primary like-btn mt-2" data-pk="{{ post.pk }}">
      {% if user in post.likes.all %}
        â¤ï¸ ã„ã„ã­
      {% else %}
        ğŸ¤ ã„ã„ã­
      {% endif %}
    </button>
    <!-- ã„ã„ã­æ•°è¡¨ç¤º -->
    <span id="like-count-{{ post.pk }}" class="ms-2">{{ post.total_likes }}</span>
  </div>
</div>
{% empty %}
<p>è©²å½“ã™ã‚‹æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
{% endfor %}

<!-- éåŒæœŸã„ã„ã­ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const likeBtns = document.querySelectorAll('.like-btn');

    likeBtns.forEach(btn => {
        btn.addEventListener('click', function () {
            const postId = this.dataset.pk;
            const url = `/post/${postId}/like/`;

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // ã„ã„ã­æ•°ã‚’æ›´æ–°
                const countSpan = document.getElementById(`like-count-${postId}`);
                if (countSpan) {
                    countSpan.textContent = data.count;
                }

                // ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
                if (data.liked) {
                    this.textContent = ' â¤ï¸ ã„ã„ã­';
                } else {
                    this.textContent = ' ğŸ¤ ã„ã„ã­';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ã„ã„ã­ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            });
        });
    });
});
</script>

{% endblock %}
